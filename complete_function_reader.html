<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´åŠŸèƒ½TXTé˜…è¯»å™¨</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="icon" href="icon-192.png" type="image/png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* è§†å›¾ç³»ç»Ÿ */
        .view {
            height: 100vh;
            display: none;
            flex-direction: column;
        }
        
        .view.active {
            display: flex;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-settings {
            background: #9b59b6;
        }
        
        .btn-settings:hover {
            background: #8e44ad;
        }
        
        /* ä¹¦æ¶ç•Œé¢ */
        .bookshelf-header {
            padding: 20px;
            text-align: center;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .bookshelf-header h1 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .add-book-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .add-book-btn:hover {
            background: #27ae60;
        }
        
        .book-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }
        
        .book-card {
            background: white;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .book-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .book-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .book-name {
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .book-status {
            font-size: 0.7rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .empty-shelf {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* é˜…è¯»ç•Œé¢ */
        .reader-header {
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .reader-title {
            margin: 0;
            flex: 1;
            text-align: center;
            padding: 0 10px;
            font-size: 1.1rem;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .reader-actions {
            display: flex;
            gap: 10px;
        }
        
        .reader-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 17px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: white;
        }
        
        /* ä¸»é¢˜æ ·å¼ */
        .theme-default {
            background: #f8f9fa;
            color: #333;
        }
        
        .theme-night {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-green {
            background: #f0f8f0;
            color: #2e7d32;
        }
        
        .theme-amber {
            background: #fdf6e3;
            color: #5c4a2d;
        }
        
        .progress-container {
            height: 3px;
            background: #ecf0f1;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.2s;
        }
        
        /* ç¼–ç é€‰æ‹©å™¨ */
        .encoding-selector {
            display: flex;
            gap: 8px;
            margin: 15px 20px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .encoding-btn {
            padding: 5px 10px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .encoding-btn:hover {
            background: #d5dbdb;
        }
        
        .encoding-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* è®¾ç½®ç•Œé¢ */
        .settings-header {
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .setting-group {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .setting-group h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .font-size-slider {
            flex: 1;
        }
        
        .font-size-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }
        
        .font-family-select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .theme-option {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .theme-option:hover {
            transform: translateY(-2px);
        }
        
        .theme-option.active {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .theme-default-preview {
            background: #f8f9fa;
            color: #333;
        }
        
        .theme-night-preview {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-green-preview {
            background: #f0f8f0;
            color: #2e7d32;
        }
        
        .theme-amber-preview {
            background: #fdf6e3;
            color: #5c4a2d;
        }
        
        input[type="file"] {
            display: none;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }
        
        @media (max-width: 768px) {
            .book-list {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
                gap: 15px;
                padding: 15px;
            }
            
            .reader-content {
                padding: 15px;
                font-size: 16px;
            }
            
            .theme-options {
                grid-template-columns: 1fr;
            }
            
            .encoding-selector {
                gap: 5px;
            }
            
            .encoding-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .book-list {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .reader-header {
                padding: 12px 15px;
            }
            
            .reader-content {
                padding: 12px;
                font-size: 15px;
            }
            
            .reader-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- ä¹¦æ¶ç•Œé¢ -->
        <div id="bookshelf-view" class="view active">
            <div class="bookshelf-header">
                <h1>ğŸ“š æˆ‘çš„ä¹¦æ¶</h1>
                <button id="add-book" class="add-book-btn">â• æ·»åŠ ä¹¦ç±</button>
                <input type="file" id="file-input" accept=".txt" multiple>
                <p style="margin-top: 10px; color: #7f8c8d; font-size: 0.9rem;">
                    æ”¯æŒUTF-8ã€GBKç¼–ç ï¼Œè‡ªåŠ¨è®°å¿†é˜…è¯»ä½ç½®
                </p>
            </div>
            
            <div id="book-list" class="book-list">
                <div class="empty-shelf" id="empty-shelf">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“–</div>
                    <p>ä¹¦æ¶è¿˜æ˜¯ç©ºçš„</p>
                    <p>ç‚¹å‡»"æ·»åŠ ä¹¦ç±"å¼€å§‹é˜…è¯»</p>
                </div>
            </div>
        </div>
        
        <!-- é˜…è¯»ç•Œé¢ -->
        <div id="reader-view" class="view">
            <div class="reader-header">
                <button id="back-to-shelf" class="btn">ğŸ”™ ä¹¦æ¶</button>
                <h3 id="book-title" class="reader-title">ä¹¦ç±æ ‡é¢˜</h3>
                <div class="reader-actions">
                    <button id="settings-btn" class="btn btn-settings">âš™ï¸ è®¾ç½®</button>
                </div>
            </div>
            
            <div class="encoding-selector">
                <div class="encoding-btn active" data-encoding="auto">ğŸ¤– è‡ªåŠ¨</div>
                <div class="encoding-btn" data-encoding="utf-8">ğŸ”¤ UTF-8</div>
                <div class="encoding-btn" data-encoding="gbk">ğŸ‡¨ğŸ‡³ GBK</div>
                <div class="encoding-btn" data-encoding="big5">ğŸ‡­ğŸ‡° Big5</div>
            </div>
            
            <div id="content" class="reader-content"></div>
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- è®¾ç½®ç•Œé¢ -->
        <div id="settings-view" class="view">
            <div class="settings-header">
                <button id="back-to-reader" class="btn">â¬…ï¸ è¿”å›</button>
                <h3>âš™ï¸ é˜…è¯»è®¾ç½®</h3>
                <button id="save-settings" class="btn">ä¿å­˜</button>
            </div>
            
            <div class="settings-content">
                <div class="setting-group">
                    <h3>å­—ä½“è®¾ç½®</h3>
                    <div class="font-size-control">
                        <label>å­—ä½“å¤§å°:</label>
                        <input type="range" id="font-size" min="12" max="30" value="17" class="font-size-slider">
                        <span id="font-size-value" class="font-size-value">17px</span>
                    </div>
                    <div style="margin-top: 20px;">
                        <label>å­—ä½“ç±»å‹:</label>
                        <select id="font-family" class="font-family-select">
                            <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                            <option value="SimSun">å®‹ä½“</option>
                            <option value="SimHei">é»‘ä½“</option>
                            <option value="KaiTi">æ¥·ä½“</option>
                            <option value="Arial">Arial</option>
                        </select>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3>èƒŒæ™¯ä¸»é¢˜</h3>
                    <div class="theme-options">
                        <div class="theme-option theme-default-preview active" data-theme="default">
                            <div>é»˜è®¤</div>
                        </div>
                        <div class="theme-option theme-night-preview" data-theme="night">
                            <div>å¤œé—´</div>
                        </div>
                        <div class="theme-option theme-green-preview" data-theme="green">
                            <div>æŠ¤çœ¼ç»¿</div>
                        </div>
                        <div class="theme-option theme-amber-preview" data-theme="amber">
                            <div>ç¥ç€è‰²</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // åº”ç”¨è®¾ç½®
        const appSettings = {
            fontSize: 17,
            fontFamily: 'Microsoft YaHei',
            theme: 'default'
        };
        
        // ä¹¦ç±æ•°æ®
        let books = [];
        let currentBook = null;
        let currentFile = null;
        
        // DOMå…ƒç´ 
        const elements = {
            bookshelfView: document.getElementById('bookshelf-view'),
            readerView: document.getElementById('reader-view'),
            settingsView: document.getElementById('settings-view'),
            addBook: document.getElementById('add-book'),
            fileInput: document.getElementById('file-input'),
            bookList: document.getElementById('book-list'),
            emptyShelf: document.getElementById('empty-shelf'),
            backToShelf: document.getElementById('back-to-shelf'),
            settingsBtn: document.getElementById('settings-btn'),
            backToReader: document.getElementById('back-to-reader'),
            saveSettings: document.getElementById('save-settings'),
            bookTitle: document.getElementById('book-title'),
            content: document.getElementById('content'),
            encodingBtns: document.querySelectorAll('.encoding-btn'),
            progressBar: document.getElementById('progress-bar'),
            fontSize: document.getElementById('font-size'),
            fontSizeValue: document.getElementById('font-size-value'),
            fontFamily: document.getElementById('font-family'),
            themeOptions: document.querySelectorAll('.theme-option')
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettingsFromStorage();
            loadBooksFromStorage();
            renderBookshelf();
            applySettings();
            bindEvents();
        });
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
        function loadSettingsFromStorage() {
            try {
                const savedSettings = localStorage.getItem('completeTxtReaderSettings');
                if (savedSettings) {
                    Object.assign(appSettings, JSON.parse(savedSettings));
                }
            } catch (e) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥', e);
            }
        }
        
        // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
        function saveSettingsToStorage() {
            try {
                localStorage.setItem('completeTxtReaderSettings', JSON.stringify(appSettings));
            } catch (e) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥', e);
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¹¦ç±
        function loadBooksFromStorage() {
            try {
                const savedBooks = localStorage.getItem('completeTxtReaderBooks');
                if (savedBooks) {
                    books = JSON.parse(savedBooks);
                }
            } catch (e) {
                console.error('åŠ è½½ä¹¦ç±æ•°æ®å¤±è´¥', e);
                books = [];
            }
        }
        
        // ä¿å­˜ä¹¦ç±åˆ°æœ¬åœ°å­˜å‚¨
        function saveBooksToStorage() {
            try {
                localStorage.setItem('completeTxtReaderBooks', JSON.stringify(books));
            } catch (e) {
                console.error('ä¿å­˜ä¹¦ç±æ•°æ®å¤±è´¥', e);
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            elements.addBook.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.backToShelf.addEventListener('click', showBookshelf);
            elements.settingsBtn.addEventListener('click', showSettings);
            elements.backToReader.addEventListener('click', showReader);
            elements.saveSettings.addEventListener('click', saveSettings);
            elements.encodingBtns.forEach(btn => btn.addEventListener('click', handleEncodingChange));
            
            // å­—ä½“å¤§å°æ§åˆ¶
            elements.fontSize.addEventListener('input', function() {
                elements.fontSizeValue.textContent = this.value + 'px';
            });
            
            // ä¸»é¢˜é€‰æ‹©
            elements.themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    elements.themeOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            elements.content.addEventListener('scroll', updateProgress);
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.name.endsWith('.txt')) {
                    loadFile(file);
                }
            });
            elements.fileInput.value = '';
        }
        
        // åŠ è½½æ–‡ä»¶
        function loadFile(file) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¹¦ç±
            const existingBookIndex = books.findIndex(book => book.name === file.name.replace('.txt', ''));
            if (existingBookIndex >= 0) {
                // æ›´æ–°ç°æœ‰ä¹¦ç±
                const existingBook = books[existingBookIndex];
                currentFile = file;
                openBook(existingBook);
                return;
            }
            
            // åˆ›å»ºæ–°ä¹¦ç±
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const book = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    name: file.name.replace('.txt', ''),
                    content: content,
                    lastPosition: 0,
                    encoding: 'auto',
                    createdAt: new Date().toISOString(),
                    lastRead: new Date().toISOString()
                };
                
                books.push(book);
                saveBooksToStorage();
                renderBookshelf();
                openBook(book);
                currentFile = file;
            };
            
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            // å°è¯•UTF-8ç¼–ç 
            reader.readAsText(file, 'utf-8');
        }
        
        // æ‰“å¼€ä¹¦ç±
        function openBook(book) {
            currentBook = book;
            elements.bookTitle.textContent = book.name;
            elements.content.textContent = book.content;
            
            // æ»šåŠ¨åˆ°ä¸Šæ¬¡ä½ç½®
            elements.content.scrollTop = book.lastPosition || 0;
            updateProgress();
            
            // æ˜¾ç¤ºé˜…è¯»ç•Œé¢
            elements.bookshelfView.classList.remove('active');
            elements.readerView.classList.add('active');
        }
        
        // æ˜¾ç¤ºä¹¦æ¶
        function showBookshelf() {
            // ä¿å­˜é˜…è¯»ä½ç½®
            if (currentBook) {
                currentBook.lastPosition = elements.content.scrollTop;
                currentBook.lastRead = new Date().toISOString();
                saveBooksToStorage();
            }
            
            elements.readerView.classList.remove('active');
            elements.settingsView.classList.remove('active');
            elements.bookshelfView.classList.add('active');
        }
        
        // å¤„ç†ç¼–ç åˆ‡æ¢
        function handleEncodingChange(e) {
            if (!currentFile || !currentBook) return;
            
            const encoding = e.target.dataset.encoding;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            elements.encodingBtns.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            // é‡æ–°åŠ è½½æ–‡ä»¶
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                currentBook.content = content;
                elements.content.textContent = content;
                currentBook.encoding = encoding;
                currentBook.lastPosition = 0; // é‡ç½®ä½ç½®
                saveBooksToStorage();
            };
            
            reader.onerror = function() {
                alert('ç¼–ç åˆ‡æ¢å¤±è´¥');
            };
            
            reader.readAsText(currentFile, encoding);
        }
        
        // æ˜¾ç¤ºè®¾ç½®
        function showSettings() {
            // åˆå§‹åŒ–è®¾ç½®ç•Œé¢
            elements.fontSize.value = appSettings.fontSize;
            elements.fontSizeValue.textContent = appSettings.fontSize + 'px';
            elements.fontFamily.value = appSettings.fontFamily;
            
            // è®¾ç½®ä¸»é¢˜é€‰ä¸­çŠ¶æ€
            elements.themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === appSettings.theme) {
                    option.classList.add('active');
                }
            });
            
            elements.readerView.classList.remove('active');
            elements.settingsView.classList.add('active');
        }
        
        // æ˜¾ç¤ºé˜…è¯»å™¨
        function showReader() {
            elements.settingsView.classList.remove('active');
            elements.readerView.classList.add('active');
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            appSettings.fontSize = parseInt(elements.fontSize.value);
            appSettings.fontFamily = elements.fontFamily.value;
            appSettings.theme = document.querySelector('.theme-option.active').dataset.theme;
            
            saveSettingsToStorage();
            applySettings();
            showReader();
        }
        
        // åº”ç”¨è®¾ç½®
        function applySettings() {
            elements.content.style.fontSize = appSettings.fontSize + 'px';
            elements.content.style.fontFamily = appSettings.fontFamily;
            
            // åº”ç”¨ä¸»é¢˜
            document.body.className = '';
            document.body.classList.add('theme-' + appSettings.theme);
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const content = elements.content;
            const progress = content.scrollHeight > content.clientHeight ? 
                (content.scrollTop / (content.scrollHeight - content.clientHeight)) * 100 : 0;
            elements.progressBar.style.width = progress + '%';
            
            // ä¿å­˜é˜…è¯»ä½ç½®
            if (currentBook) {
                currentBook.lastPosition = content.scrollTop;
                // é˜²æŠ–ä¿å­˜
                clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(saveBooksToStorage, 1000);
            }
        }
        
        // æ¸²æŸ“ä¹¦æ¶
        function renderBookshelf() {
            if (books.length === 0) {
                elements.emptyShelf.style.display = 'block';
                elements.bookList.innerHTML = '';
                elements.bookList.appendChild(elements.emptyShelf);
                return;
            }
            
            elements.emptyShelf.style.display = 'none';
            elements.bookList.innerHTML = '';
            
            // æŒ‰æœ€åé˜…è¯»æ—¶é—´æ’åºï¼Œæœ€è¿‘é˜…è¯»çš„åœ¨å‰é¢
            books.sort((a, b) => new Date(b.lastRead) - new Date(a.lastRead));
            
            books.forEach(book => {
                // è®¡ç®—é˜…è¯»è¿›åº¦
                const progress = book.lastPosition > 0 ? 'ç¶šãã‹ã‚‰' : 'æ–°è¦';
                const lastRead = new Date(book.lastRead);
                const timeAgo = getTimeAgo(lastRead);
                
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <div class="book-icon">ğŸ“–</div>
                    <div class="book-name">${book.name}</div>
                    <div class="book-status">${progress} Â· ${timeAgo}</div>
                `;
                
                bookCard.addEventListener('click', () => {
                    openBook(book);
                });
                
                elements.bookList.appendChild(bookCard);
            });
        }
        
        // è·å–æ—¶é—´å·®æè¿°
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffDays > 0) {
                return `${diffDays}æ—¥å‰`;
            } else if (diffHours > 0) {
                return `${diffHours}æ™‚é–“å‰`;
            } else if (diffMinutes > 0) {
                return `${diffMinutes}åˆ†å‰`;
            } else {
                return 'ãŸã£ãŸä»Š';
            }
        }
        
        // é¡µé¢å¸è½½æ—¶ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', function() {
            if (currentBook) {
                currentBook.lastPosition = elements.content.scrollTop;
                currentBook.lastRead = new Date().toISOString();
                saveBooksToStorage();
            }
        });
    </script>
</body>
</html>